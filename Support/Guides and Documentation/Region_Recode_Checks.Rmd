---
title: "Region Label Checks"
author: "Tom"
date: "6/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
GLD <- "Y:/GLD-Harmonization/551206_TM/PHL"

```


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```
A document to quickly review the distribution of labeled vs non-labeled region data for various years 

# 2016 

I'll read the RDS files since they're already created.
```{r, echo=FALSE}
lfs2016jan <- readRDS(file.path(GLD, "PHL_2016_LFS/PHL_2016_LFS_v01_M/Data/R/LFS JAN2016.Rds"))
lfs2016apr <- readRDS(file.path(GLD, "PHL_2016_LFS/PHL_2016_LFS_v01_M/Data/R/LFS APR2016.Rds"))
lfs2016jul <- readRDS(file.path(GLD, "PHL_2016_LFS/PHL_2016_LFS_v01_M/Data/R/LFS JUL2016.Rds"))
lfs2016oct <- readRDS(file.path(GLD, "PHL_2016_LFS/PHL_2016_LFS_v01_M/Data/R/LFS OCT2016.Rds"))

```

The running theory for 2016 is that:
- all rounds are numeric except for April
- In January, value `41` corresponds to value `4` for April/July/October and 
- In January, value `42` corresponds to value `17` for April/July/October 

Let's create a mini dataset and test this.

```{r}
# append and trim 
jan <- lfs2016jan %>%
  select(pufreg, svymo) %>%
  mutate(pufreg = case_when(pufreg == 4  ~ 41,
                         pufreg == 17 ~ 42, 
                         TRUE      ~ pufreg))

apr <- lfs2016apr %>%
  mutate(pufreg = as.numeric(pufreg)) %>%
  select(pufreg, pufreg, pufsvymo) %>%
  mutate(pufreg = case_when(pufreg == 4  ~ 41,
                         pufreg == 17 ~ 42, 
                         TRUE      ~ pufreg)) %>%
  rename(svymo = pufsvymo)

jul <- lfs2016jul %>%
  select(pufreg, pufsvymo) %>%
  mutate(pufreg = case_when(pufreg == 4  ~ 41,
                         pufreg == 17 ~ 42, 
                         TRUE      ~ pufreg)) %>%
  rename(svymo = pufsvymo)

oct <- lfs2016oct %>%
  select(pufreg, pufsvymo) %>%
  mutate(pufreg = case_when(pufreg == 4  ~ 41,
                         pufreg == 17 ~ 42, 
                         TRUE      ~ pufreg)) %>%
  rename(svymo = pufsvymo)
  

lfs2016_reg <- bind_rows(jan, apr, jul, oct)

```


## Plot by round

After recoding to the same levels, there seems to be pretty good visual evidence to support the recoding schema above, as the distribution is almost the same across all rounds. The only visual exception is the final round, which has a value of 18, which wasn't touched during the recode, which includes a new region not mentioned in the previous rounds.

```{r}

hist <- ggplot(lfs2016_reg, aes(pufreg)) +
  geom_histogram(binwidth = 1) + 
  scale_x_continuous(n.breaks = 10) +
  facet_grid(rows = vars(svymo), labeller = label_both) + 
  theme_minimal() +
  labs(x = "Region Numeric Value", y = "Count")

hist
```


# 2006 

Repeating the same steps for 2006 to verify that the numeric values are likely the same as the labeled ones. 

```{r, echo=FALSE}
lfs2006jan <- readRDS(file.path(GLD, "PHL_2006_LFS/PHL_2006_LFS_v01_M/Data/R/LFS JAN2006.Rds")) %>%
  select(pufreg, svymo)
lfs2006apr <- readRDS(file.path(GLD, "PHL_2006_LFS/PHL_2006_LFS_v01_M/Data/R/LFS APR2006.Rds")) %>%
  select(pufreg, svymo)
lfs2006jul <- readRDS(file.path(GLD, "PHL_2006_LFS/PHL_2006_LFS_v01_M/Data/R/LFS JUL2006.Rds")) %>%
  select(creg, svymo)
lfs2006oct <- readRDS(file.path(GLD, "PHL_2006_LFS/PHL_2006_LFS_v01_M/Data/R/LFS OCT2006.Rds")) %>%
  select(creg, svymo)

```

Resulting comparison histogram looks good. Provisional stylized support for 2006.

```{r}
# append and trim 
lfs2006jan <- lfs2006jan %>%
  mutate(
    reg_num = as.numeric(pufreg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num))

lfs2006apr <- lfs2006apr %>%
  mutate(
    reg_num = as.numeric(pufreg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num))

lfs2006jul <- lfs2006jul %>%
  mutate(
    reg_num = case_when(creg == 4  ~ 41,
                         creg == 17 ~ 42, 
                         TRUE      ~ creg)) 

lfs2006oct <- lfs2006oct %>%
  mutate(
    reg_num = as.numeric(creg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num))
  

lfs2006_reg <- bind_rows(lfs2006jan, lfs2006apr, lfs2006jul, lfs2006oct)
assertthat::assert_that(sum(is.na(lfs2006_reg$reg_num )) == 0 ) # ensure we have no missing values in the new numeric var


# ggplot 
hist2006 <- ggplot(lfs2006_reg, aes(reg_num)) +
  geom_histogram(binwidth = 1) + 
  scale_x_continuous(n.breaks = 10) +
  facet_grid(rows = vars(svymo), labeller = label_both) + 
  theme_minimal() +
  labs(x = "Region Numeric Value", y = "Count")

hist2006
```

# 2017 


```{r, echo=FALSE}
lfs2017jan <- readRDS(file.path(GLD, "PHL_2017_LFS/PHL_2017_LFS_v01_M/Data/R/LFS JAN2017.Rds")) %>%
  select(pufreg, pufsvymo)
lfs2017apr <- readRDS(file.path(GLD, "PHL_2017_LFS/PHL_2017_LFS_v01_M/Data/R/LFS APR2017.Rds")) %>%
  select(lreg, lmonth)
  n_miss_apr17_mo <- sum(is.na(lfs2017apr$lmonth)) # the raw data has a few missing obs for month

lfs2017jul <- readRDS(file.path(GLD, "PHL_2017_LFS/PHL_2017_LFS_v01_M/Data/R/LFS JUL2017.Rds")) %>%
  select(pufreg, pufsvymo)
lfs2017oct <- readRDS(file.path(GLD, "PHL_2017_LFS/PHL_2017_LFS_v01_M/Data/R/LFS OCT2017.Rds")) %>%
  select(pufreg, pufsvymo)

```

Resulting comparison histogram looks good. Provisional stylized support for 2017.

```{r}
# append and trim 
lfs2017jan <- lfs2017jan %>%
  mutate(
    reg_num = as.numeric(pufreg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num))

lfs2017apr <- lfs2017apr %>%
  mutate(
    reg_num = as.numeric(lreg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num)) %>%
  rename(pufsvymo = lmonth)

lfs2017jul <- lfs2017jul %>%
  mutate(
    reg_num = as.numeric(pufreg),
    reg_num = case_when(pufreg == 4  ~ 41,
                         pufreg == 17 ~ 42, 
                         TRUE      ~ pufreg)) 

lfs2017oct <- lfs2017oct %>%
  mutate(
    reg_num = as.numeric(pufreg),
    reg_num = case_when(reg_num == 4  ~ 41,
                         reg_num == 17 ~ 42, 
                         TRUE      ~ reg_num))
  

lfs2017_reg <- bind_rows(lfs2017jan, lfs2017apr, lfs2017jul, lfs2017oct) %>%
  filter(!is.na(pufsvymo))
assertthat::assert_that(sum(is.na(lfs2017_reg$reg_num )) == 0 ) # ensure we have no missing values in the new numeric var


# ggplot 
hist2017 <- ggplot(lfs2017_reg, aes(reg_num)) +
  geom_histogram(binwidth = 1) + 
  scale_x_continuous(n.breaks = 10) +
  facet_grid(rows = vars(pufsvymo), labeller = label_both) + 
  theme_minimal() +
  labs(x = "Region Numeric Value", y = "Count")

hist2017
```

